name: Auto Merge PR

on:
  workflow_run:
    workflows: ["CI Changes related to node PRs....."]
    types:
      - completed
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [labeled, unlabeled]

permissions:
  contents: write
  pull-requests: write
concurrency:
  group: auto-merge-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true
jobs:
  auto-merge:
    runs-on: oh-billing-runner-scale-set
    if: >
      github.event.workflow_run.conclusion == 'success' ||
      github.event_name == 'pull_request_review' ||
      github.event_name == 'pull_request'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Get PR Number
        id: get-pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            PR_NUMBER=$(gh pr list --search "${{ github.event.workflow_run.head_sha }}" --json number --jq '.[0].number')
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Labels
        id: check-labels
        run: |
          LABELS=$(gh pr view ${{ steps.get-pr.outputs.pr_number }} --json labels --jq '.labels[].name')
          
          if echo "$LABELS" | grep -q "do-not-merge/hold"; then
            echo "‚ùå PR has 'do-not-merge/hold' label - blocking merge"
            exit 1
          fi
          
          if echo "$LABELS" | grep -q "approved"; then
            echo "has_approved_label=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR has 'approved' label"
          else
            echo "‚ùå PR missing 'approved' label - blocking merge"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Code Owner Approval
        id: check-codeowners
        if: steps.check-labels.outputs.has_approved_label == 'true'
        run: |
          # Get list of code owners from OWNERS_ALIASES
          CODE_OWNERS=$(cat OWNERS_ALIASES | grep -A 100 "developers:" | grep "^\s*-" | sed 's/^\s*-\s*//' | tr '\n' '|' | sed 's/|$//')
          
          # Get approved reviewers
          APPROVED_REVIEWERS=$(gh pr view ${{ steps.get-pr.outputs.pr_number }} --json reviews --jq '[.reviews[] | select(.state == "APPROVED") | .author.login] | unique | .[]')
          
          # Check if any approved reviewer is a code owner
          CODEOWNER_APPROVED=false
          while IFS= read -r reviewer; do
            if echo "$reviewer" | grep -qE "^($CODE_OWNERS)$"; then
              echo "‚úÖ Code owner '$reviewer' has approved the PR"
              CODEOWNER_APPROVED=true
              break
            fi
          done <<< "$APPROVED_REVIEWERS"
          
          if [ "$CODEOWNER_APPROVED" = true ]; then
            echo "codeowners_approved=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No code owner approval found"
            echo "Approved reviewers: $APPROVED_REVIEWERS"
            echo "Required code owners from: $CODE_OWNERS"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable Auto-Merge
        if: >
          steps.check-labels.outputs.has_approved_label == 'true' &&
          steps.check-codeowners.outputs.codeowners_approved == 'true'
        run: |
          gh pr merge ${{ steps.get-pr.outputs.pr_number }} --auto --merge
          echo "üéâ Auto-merge enabled for PR #${{ steps.get-pr.outputs.pr_number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
